-- [[ HỆ THỐNG BẢO MẬT TỐI CAO ]]
local VirtualUser = game:GetService("VirtualUser")
game:GetService("Players").LocalPlayer.Idled:Connect(function()
    VirtualUser:CaptureController()
    VirtualUser:ClickButton2(Vector2.new())
end)

-- [[ CẤU HÌNH ]]
_G.Kaitun = true
_G.AutoStats = true -- Tự nâng điểm
local Speed = 275 -- Tốc độ an toàn chống Reset Level

-- [[ HÀM DI CHUYỂN XUYÊN TƯỜNG ]]
local function tweenMove(targetCFrame)
    local lp = game.Players.LocalPlayer
    if not lp.Character or not lp.Character:FindFirstChild("HumanoidRootPart") then return end
    local hrp = lp.Character.HumanoidRootPart
    local dist = (targetCFrame.Position - hrp.Position).Magnitude
    
    -- Noclip (Xuyên tường)
    for _, v in pairs(lp.Character:GetDescendants()) do
        if v:IsA("BasePart") then v.CanCollide = false end
    end
    
    local tween = game:GetService("TweenService"):Create(hrp, TweenInfo.new(dist/Speed, Enum.EasingStyle.Linear), {CFrame = targetCFrame})
    tween:Play()
    return tween
end

-- [[ TỰ ĐỘNG NÂNG ĐIỂM (STATS) ]]
spawn(function()
    while task.wait(2) do
        if _G.AutoStats then
            local args = {"AddPoint", "Melee", 3} -- Ưu tiên Melee để farm nhanh
            game:GetService("ReplicatedStorage").Remotes.CommF_:InvokeServer(unpack(args))
        end
    end
end)

-- [[ HỆ THỐNG PHÂN LOẠI NHIỆM VỤ THEO LEVEL (SEA 1) ]]
local function GetQuestData()
    local lvl = game.Players.LocalPlayer.Data.Level.Value
    if lvl >= 1 and lvl < 15 then
        return "BanditQuest1", "Bandit", 1, CFrame.new(1059, 15, 1549), CFrame.new(1145, 17, 1634)
    elseif lvl >= 15 and lvl < 30 then
        return "MonkeyQuest1", "Monkey", 1, CFrame.new(-1598, 37, 153), CFrame.new(-1623, 21, 142)
    -- Bạn có thể thêm hàng trăm điều kiện elseif cho đến Sea 3 tại đây
    end
end

-- [[ VÒNG LẶP KAITUN CHÍNH ]]
spawn(function()
    while task.wait() do
        if _G.Kaitun then
            pcall(function()
                local qName, mName, qID, qNPC, mPos = GetQuestData()
                
                -- Nếu chưa nhận Quest thì bay tới NPC
                if not game.Players.LocalPlayer.PlayerGui.Main.Quest.Visible then
                    tweenMove(qNPC)
                    if (game.Players.LocalPlayer.Character.HumanoidRootPart.Position - qNPC.Position).Magnitude < 10 then
                        game:GetService("ReplicatedStorage").Remotes.CommF_:InvokeServer("StartQuest", qName, qID)
                    end
                else
                    -- Nếu đã có Quest thì đi diệt quái
                    for _, v in pairs(game.Workspace.Enemies:GetChildren()) do
                        if v.Name == mName and v:FindFirstChild("Humanoid") and v.Humanoid.Health > 0 then
                            repeat
                                task.wait()
                                -- Bay trên đầu quái 10 studs để Anti-Ban
                                tweenMove(v.HumanoidRootPart.CFrame * CFrame.new(0, 10, 0))
                                VirtualUser:CaptureController()
                                VirtualUser:ClickButton1(Vector2.new())
                            until v.Humanoid.Health <= 0 or not _G.Kaitun or not v.Parent
                        end
                    end
                    -- Nếu không thấy quái thì bay tới bãi quái
                    if #game.Workspace.Enemies:GetChildren() == 0 then
                        tweenMove(mPos)
                    end
                end
            end)
        end
    end
end)
